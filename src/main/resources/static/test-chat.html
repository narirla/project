<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WS Chat Test</title>
  <script src="https://unpkg.com/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://unpkg.com/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; }
    .row { display: flex; gap: 8px; margin: 8px 0; }
    #log { border:1px solid #ccc; height: 300px; overflow:auto; padding:8px; }
    input, button { padding:8px; }
  </style>
</head>
<body>
<h2>WebSocket Chat (DB 저장)</h2>
<div class="row">
  <label>Room ID <input id="roomId" value="1"></label>
  <label>Sender ID <input id="senderId" value="1"></label>
  <button id="btnConnect">Connect</button>
  <button id="btnDisconnect" disabled>Disconnect</button>
</div>

<div id="log"></div>

<div class="row">
  <input id="content" placeholder="메시지..." style="flex:1">
  <button id="btnSend" disabled>Send</button>
</div>

<script>
  let stomp = null; // 전역 하나만!

  const $ = sel => document.querySelector(sel);
  const log = (msg) => {
    const div=document.createElement('div');
    div.textContent = msg;
    $('#log').appendChild(div);
    $('#log').scrollTop = $('#log').scrollHeight;
  };

  async function ensureRoom(productId, buyerId, sellerId){
    const res = await fetch(`/api/rooms/ensure?productId="1"&buyerId="8"&sellerId="7"`, { method:'POST' });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`ensure failed: ${res.status} ${t}`);
    }
    return res.json(); // {roomId: N}
  }

  async function connect(){
    try{
      // 1) 먼저 방 보장 (필요시 productId/buyerId/sellerId 값을 UI에서 받도록 수정)
<!--      const buyerId = Number($('#senderId').value); // 데모: 나를 구매자로 가정-->
      const buyerId = 8; // 데모: 나를 구매자로 가정
      const productId = 1;                          // 데모 값
      const sellerId = 7;                          // 데모 값
      const ensured = await ensureRoom(productId, buyerId, sellerId);
      const roomId = ensured.roomId;
      $('#roomId').value = roomId; // UI에도 반영

      // 2) WebSocket 연결
      const socket = new SockJS('/ws');           // 서버 엔드포인트와 동일해야 함
      stomp = Stomp.over(socket);
      stomp.connect({}, () => {
        log('[connected] roomId=' + roomId);
        $('#btnConnect').disabled = true;
        $('#btnDisconnect').disabled = false;
        $('#btnSend').disabled = false;

        // 3) 구독
        stomp.subscribe(`/topic/room/${roomId}`, (frame) => {
          const body = JSON.parse(frame.body);
          log(`[RECV] #${body.msgId} from ${body.senderId} : ${body.content}`);
        });

      }, (err) => {
        log('[stomp error] ' + err);
      });
    } catch(e){
      console.error(e);
      log('[connect failed] ' + e.message);
    }
  }

  function disconnect(){
    if(stomp){ stomp.disconnect(()=>log('[disconnected]')); }
    $('#btnConnect').disabled = false;
    $('#btnDisconnect').disabled = true;
    $('#btnSend').disabled = true;
  }

  function uuid(){
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
      const r = Math.random()*16|0, v=c=='x'?r:(r&0x3|0x8);
      return v.toString(16);
    });
  }

  function send(){
    const payload = {
      roomId: Number($('#roomId').value),
      senderId: Number($('#senderId').value), // 데모용 (운영은 서버 인증에서 식별)
      content: $('#content').value,
      clientMsgId: uuid()
    };
    stomp.send('/app/chat.send', {}, JSON.stringify(payload));
    $('#content').value = '';
  }

  $('#btnConnect').onclick = connect;
  $('#btnDisconnect').onclick = disconnect;
  $('#btnSend').onclick = send;
  $('#content').addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
</script>
</body>
</html>
